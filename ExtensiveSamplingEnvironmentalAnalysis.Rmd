---
title: "Analysis of Extensive Watershed Plant Community Sampling (Chapter 3 pt 1)"
author: "Emily J. Rollinson"
date: "Wednesday, November 12, 2014"
output: html_document
---

Import the species list
```{r}
require(RCurl)
options(RCurlOptions = list(cainfo = system.file("CurlSSL", "cacert.pem", package = "RCurl")))
raw <- getURL("https://raw.githubusercontent.com/erollinson/Dissertation/master/2013_species_presence_list.csv") #insert the  raw URL for the data file on github here
list <- read.csv(text = raw) #read in the github file
```

Cast the list into a site by species matrix, and convert the output (default of class 'cast') to a dataframe.

```{r}
require(reshape)
matrix<-cast(list, River ~ Species, value='Presence')
comm<-as.data.frame(matrix)
```

Import the environment matrix
```{r}
require(RCurl)
options(RCurlOptions = list(cainfo = system.file("CurlSSL", "cacert.pem", package = "RCurl")))
raw <- getURL("https://raw.githubusercontent.com/erollinson/Dissertation/master/2013_sites_allenvt_quant.csv") #insert the  raw URL for the data file on github here
env<- read.csv(text = raw) #read in the github file
```

Reframe the matrices so that the river names are row names and not a column
```{r}
rownames(comm)<-comm$River
comm<-comm[,2:288]
rownames(env)<-env$River
env<-env[,3:70]
```

Reframe the matrices so all the columns are numeric
```{r}
comm[,1:287]<-sapply(comm[,1:287], as.numeric)
env[,1:69]<-sapply(env[,1:68], as.numeric)
```

Make separate environment matrices for the different buffer sizes (100m, 1km, 10km)
```{r}
env100m<-env[,1:38]
env1km<-env[,c(1:23,39:53)]
env10km<-env[,c(1:23,54:68)]
```

Run a CCA for quantitative variables
n.b. dummycoding for river flow direction is 1 through 8 for N, NE, E, SE, S, SW, W, NW respectively (this is now an obsolete note - removed from the quantitative variables since it renders distances meaningless - NW is not most distant from N even though 1 is most distant from 8; this will need to be run qualitatively
)

n.b. gave keyser kill 0 LOI - had no sample because it was entirely too rocky to sample, that seems a reasonable placeholder

Is there a way to do spatial control instead including lat/long as variables?


```{r}
require(vegan)
cca.env100m<-(cca(comm, env100m))
cca.env100m
cca.env1km<-(cca(comm, env1km))
cca.env1km
cca.env10km<-(cca(comm, env10km))
cca.env10km
```


plot the CCA - by default, this shows species as red crosses and rivers as open circles. See http://ecology.msu.montana.edu/labdsv/R/labs/lab12/lab12.html for additional plotting information.

```{r}
plot(cca.env100m)
plot(cca.env1km)
plot(cca.env10km)
```


put some numbers onto the cca

```{r}
require(vegan)
aov1<-anova.cca(cca.env100m, alpha=0.05, beta=0.01, step=100, perm.max=999)
aov2<-anova.cca(cca.env1km, alpha=0.05, beta=0.01, step=100, perm.max=999)
aov3<-anova.cca(cca.env10km, alpha=0.05, beta=0.01, step=100, perm.max=999)
aov1
aov2
aov3
```


best subset of environmental variables with maximum (rank) correlation with community dissimilarities

```{r}
require(vegan)
bioenv(comm, env100m, upto=4)
```

subset the 100m environmental data to those that are most likely of interest (remove isothermality, etc) and sum the land cover to broader categories

```{r}
envsub<-env100m[,c(1:2,6:7,16:38)]
envsub$developed<-rowSums(envsub[,24:27])
envsub$forest<-rowSums(envsub[,19:21])
envsub$cultivated<-rowSums(envsub[,15:16])
envsub$wetlands<-rowSums(envsub[,13:14])
envsub2<-envsub[,c(1:12,28:31)]
```

CCA for the subset

```{r}
cca.envsub2<-(cca(comm, envsub2))
plot(cca.envsub2)
anovasub2<-anova.cca(cca.envsub2, alpha=0.05, beta=0.01, step=100, perm.max=999)
anovasub2
bioenv(comm, envsub2, upto=16)
```


